<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatRoom - Real-Time & Shareable</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .typing-indicator span { animation: blink 1.4s infinite; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,60%,100%{opacity:.3} 30%{opacity:1} }
    .share-modal { backdrop-filter: blur(8px); }
    .copy-animation { animation: copySuccess .5s ease; }
    @keyframes copySuccess { 0%,100% { transform: scale(1) } 50% { transform: scale(1.1) } }
  </style>
</head>
<body class="bg-gray-50">
  <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-cyan-500 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <div class="flex justify-center mb-6">
        <div class="bg-gradient-to-r from-purple-500 to-cyan-500 p-4 rounded-full">
          <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
        </div>
      </div>

      <h1 class="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-600 to-cyan-600 bg-clip-text text-transparent">
        Welcome to ChatRoom
      </h1>
      <p class="text-gray-600 text-center mb-8">Enter your name and invite others!</p>

      <input id="usernameInput" maxlength="20" type="text" placeholder="Enter your name"
        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 mb-4 text-lg" />
      <button id="joinButton" disabled class="w-full bg-gradient-to-r from-purple-600 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-200 mb-3 disabled:opacity-50">
        Connecting...
      </button>

      <div class="text-center text-sm text-gray-500">Powered by Firebase. Chat is real-time! üöÄ</div>
    </div>
  </div>

  <div id="chatScreen" class="hidden h-screen flex flex-col">
    <div class="bg-white shadow-md border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-3">
          <div class="bg-gradient-to-r from-purple-500 to-cyan-500 p-2 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-bold text-gray-800">ChatRoom</h1>
            <p class="text-sm text-gray-500">Hi, <span id="currentUsername"></span>!</p>
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <button id="shareBtn" class="flex items-center gap-2 px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
            </svg>
            <span class="hidden sm:inline">Share</span>
          </button>

          <button id="toggleUsersBtn" class="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            <span class="hidden sm:inline"><span id="userCount">0</span> Online</span>
          </button>

          <button id="leaveBtn" class="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            <span class="hidden sm:inline">Leave</span>
          </button>
        </div>
      </div>
    </div>

    <div class="flex-1 max-w-6xl w-full mx-auto flex gap-4 p-4 overflow-hidden">
      <div class="flex-1 bg-white rounded-xl shadow-lg flex flex-col overflow-hidden">
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

        <div id="typingIndicator" class="px-4 py-2 text-sm text-gray-500 hidden">
          <span class="typing-indicator"><span>‚óè</span><span>‚óè</span><span>‚óè</span></span>
          <span id="typingUser"></span> is typing...
        </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50">
          <div class="flex gap-2">
            <input id="messageInput" type="text" placeholder="Type your message..."
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500" disabled />
            <button id="sendBtn" class="bg-gradient-to-r from-purple-600 to-cyan-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200" disabled>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="usersSidebar" class="w-64 bg-white rounded-xl shadow-lg p-4 hidden md:block">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          Online Users
        </h3>
        <div id="usersList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="shareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 share-modal flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform transition-all">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Invite Others</h2>
        <button id="closeShare" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="mb-6 text-center">
        <div class="bg-gradient-to-br from-purple-50 to-cyan-50 p-6 rounded-xl mb-4">
          <p class="text-sm text-gray-600 mb-3">Scan this QR code to join:</p>
          <div class="bg-white p-4 rounded-lg inline-block">
            <canvas id="qrCanvas" width="260" height="260"></canvas>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Or share this link:</label>
        <div class="flex gap-2 mb-3">
          <input id="shareLink" type="text" readonly class="flex-1 px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm" />
          <button id="copyBtnModal" class="bg-gradient-to-r from-purple-600 to-cyan-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all flex items-center gap-2">
            Copy
          </button>
          <button id="downloadQrBtn" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all flex items-center gap-2" title="Download QR as PNG">
            Download QR
          </button>
        </div>
        <p id="copySuccess" class="text-sm text-green-600 mt-2 hidden">‚úì Link copied to clipboard!</p>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-sm text-blue-800">
          <strong>üì± Mobile:</strong> Scan the QR code with your camera<br>
          <strong>üíª Desktop:</strong> Copy and paste the link<br>
          <strong>üåê Works on:</strong> Any device, anywhere!
        </p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, collection, addDoc, setDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- state ---
    let currentUser = '';
    let userId = '';
    let roomId = '';
    let typingTimeout;
    let lastTypingWrite = 0;
    let db, auth, app;
    let unsubscribeMessages = () => {};
    let unsubscribeUsers = () => {};

    const firebaseConfig = {
      apiKey: "AIzaSyD0cZN-OglXNC5_EmbElR2RTSL6OEEDYMA",
      authDomain: "echolink-3c6f7.firebaseapp.com",
      projectId: "echolink-3c6f7",
      storageBucket: "echolink-3c6f7.firebasestorage.app",
      messagingSenderId: "269557203271",
      appId: "1:269557203271:web:566bc598f1dd80203e4c62",
      measurementId: "G-5M45LPYK7S"
    };

    // init
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      getRoomId(); // ensure roomId early
      authenticateUser();
      console.log("Firebase initialized.");
    } catch (err) {
      console.error("Firebase init error:", err);
      const join = document.getElementById('joinButton');
      if (join) join.textContent = 'Init Error';
    }

    function getRoomId() {
      const url = new URL(window.location.href);
      const urlRoom = url.searchParams.get('room');
      const local = localStorage.getItem('chatRoomId');
      if (urlRoom) {
        roomId = urlRoom;
        localStorage.setItem('chatRoomId', roomId);
      } else if (local) {
        roomId = local;
      } else {
        roomId = 'room_' + Math.random().toString(36).slice(2, 11);
        localStorage.setItem('chatRoomId', roomId);
      }
      console.log("roomId:", roomId);
    }

    function messagesCollectionRef() { return collection(db, 'chatrooms', roomId, 'messages'); }
    function usersCollectionRef() { return collection(db, 'chatrooms', roomId, 'users'); }
    function userDocRef() { return doc(db, 'chatrooms', roomId, 'users', userId); }

    // auth
    function authenticateUser() {
      onAuthStateChanged(auth, (u) => {
        if (u) {
          userId = u.uid;
          const join = document.getElementById('joinButton');
          if (join) { join.disabled = false; join.textContent = 'Join Chat'; }
          console.log("authed:", userId);
        } else {
          signIn();
        }
      });
    }
    async function signIn() {
      try { await signInAnonymously(auth); console.log("signed anonymously"); }
      catch(e) { console.error("signin error", e); const join = document.getElementById('joinButton'); if (join) join.textContent='Auth Err'; }
    }

    // join / send / leave
    window.joinChat = joinChat;
    window.sendMessage = sendMessage;
    window.leaveChat = leaveChat;

    async function joinChat() {
      const username = document.getElementById('usernameInput').value.trim();
      if (!username) return console.warn("enter name");
      if (!userId) return console.warn("auth pending");

      currentUser = username;
      try {
        await setDoc(userDocRef(), { username: currentUser, isTyping: false, joinedAt: serverTimestamp() });
        await addDoc(messagesCollectionRef(), { type:'system', content: `${currentUser} joined the chat`, timestamp: serverTimestamp() });

        document.getElementById('currentUsername').textContent = currentUser;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('chatScreen').classList.remove('hidden');

        const msgIn = document.getElementById('messageInput');
        const sendB = document.getElementById('sendBtn');
        if (msgIn) msgIn.disabled = false;
        if (sendB) sendB.disabled = false;

        listenForMessages();
        listenForUsers();
        setupTypingListener();
      } catch (err) { console.error("join error", err); }
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input ? input.value.trim() : '';
      if (!currentUser) return console.warn("join first");
      if (!message) return;
      try {
        await addDoc(messagesCollectionRef(), { type:'user', sender: currentUser, senderId: userId, content: message, timestamp: serverTimestamp() });
        if (input) input.value = '';
        clearTimeout(typingTimeout); safeSetTyping(false);
      } catch (err) { console.error("send error", err); }
    }

    async function leaveChat() {
      if (!confirm("Are you sure you want to leave?")) return;
      try {
        await addDoc(messagesCollectionRef(), { type:'system', content: `${currentUser} left the chat`, timestamp: serverTimestamp() });
        await deleteDoc(userDocRef());
      } catch (err) { console.error("leave error", err); }
      try { unsubscribeMessages(); } catch(e){} try { unsubscribeUsers(); } catch(e){}
      location.reload();
    }

    // listeners
    function listenForMessages() {
      const q = query(messagesCollectionRef(), orderBy('timestamp'));
      unsubscribeMessages = onSnapshot(q, (snap) => {
        const messagesDiv = document.getElementById('messages'); if (!messagesDiv) return;
        messagesDiv.innerHTML = '';
        snap.forEach(s => displayMessage({ id: s.id, ...s.data() }));
      }, err => console.error("messages snapshot error", err));
    }
    function listenForUsers() {
      const q = query(usersCollectionRef());
      unsubscribeUsers = onSnapshot(q, (snap) => {
        const users = [], typing = [];
        snap.forEach(s => {
          const d = s.data() || {};
          users.push(d);
          if (d.isTyping && s.id !== userId) typing.push(d.username);
        });
        updateUsersList(users);
        updateTypingIndicator(typing);
      }, err => console.error("users snapshot error", err));
    }

    // typing helpers (throttled)
    function safeSetTyping(isTyping) {
      if (!userId || !roomId) return;
      const now = Date.now();
      if (isTyping && (now - lastTypingWrite < 500)) return;
      lastTypingWrite = now;
      setDoc(userDocRef(), { isTyping }, { merge: true }).catch(e => console.debug("typing write failed", e));
    }
    function setupTypingListener() {
      const input = document.getElementById('messageInput'); if (!input) return;
      input.addEventListener('input', () => {
        if (!userId) return;
        safeSetTyping(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => safeSetTyping(false), 3000);
      });
    }
    function updateTypingIndicator(typingUsers) {
      const ind = document.getElementById('typingIndicator'), span = document.getElementById('typingUser');
      if (!ind || !span) return;
      if (!typingUsers || typingUsers.length === 0) ind.classList.add('hidden');
      else if (typingUsers.length === 1) { span.textContent = typingUsers[0]; ind.classList.remove('hidden'); }
      else { span.textContent = 'Several people'; ind.classList.remove('hidden'); }
    }

    // UI helpers
    function formatTime(ts) { if (!ts || !ts.toMillis) return '...'; return new Date(ts.toMillis()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

    function displayMessage(data) {
      const messagesDiv = document.getElementById('messages'); if (!messagesDiv) return;
      const messageDiv = document.createElement('div');
      if (data.type === 'system') {
        messageDiv.className = 'flex justify-center';
        messageDiv.innerHTML = `<div class="bg-gray-100 px-4 py-2 rounded-full text-sm text-gray-600">${escapeHtml(data.content||'')}</div>`;
      } else {
        const isMe = data.senderId === userId;
        messageDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
        messageDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md">
            <div class="rounded-2xl px-4 py-2 ${isMe ? 'bg-gradient-to-r from-purple-500 to-cyan-500 text-white' : 'bg-gray-100 text-gray-800'}">
              <p class="text-xs font-semibold mb-1 opacity-75">${escapeHtml(data.sender||'Unknown')}</p>
              <p class="break-words">${escapeHtml(data.content||'')}</p>
            </div>
            <p class="text-xs text-gray-400 mt-1 px-2">${formatTime(data.timestamp)}</p>
          </div>
        `;
      }
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateUsersList(users) {
      const usersList = document.getElementById('usersList'), userCount = document.getElementById('userCount');
      if (!usersList || !userCount) return;
      userCount.textContent = users.length;
      usersList.innerHTML = users.map(u => {
        const name = u.username || 'Unknown', initial = name ? name[0].toUpperCase() : '?';
        return `<div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-400 to-cyan-400 flex items-center justify-center text-white font-bold">${initial}</div>
          <div class="flex-1"><p class="font-medium text-gray-800">${escapeHtml(name)}${name===currentUser?' (You)':''}</p>
          <div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full"></div><p class="text-xs text-gray-500">Online</p></div></div>
        </div>`}).join('');
    }

    // --- robust QR helpers ---
    
    // UPDATED: This function is rewritten to use the Qrious library
    async function generateQrForLink(link, opts = {}) {
      const canvas = document.getElementById('qrCanvas');
      if (!canvas) { console.warn('qrCanvas not found'); return; }
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Check if Qrious library is loaded - with retry mechanism
      const checkQrious = () => {
        return typeof window.Qrious === 'function';
      };

      let libReady = checkQrious();
      
      // Exponential backoff retry if library is still loading (total ~600ms)
      if (!libReady) {
        const delays = [10, 25, 50, 100, 200, 400];
        for (let d of delays) {
          await new Promise(r => setTimeout(r, d));
          libReady = checkQrious();
          if (libReady) break;
        }
      }

      if (!libReady) {
        // Library never appeared: draw helpful error message
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#c33';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('QR library (Qrious) not loaded', canvas.width/2, canvas.height/2 - 6);
        ctx.font = '12px sans-serif';
        ctx.fillText('Check console / network', canvas.width/2, canvas.height/2 + 12);
        console.error('QR generation failed: Qrious library not found');
        return;
      }

      // Use the Qrious library
      try {
        // Translate options:
        // qrcode.js 'width' -> qrious 'size'
        // qrcode.js 'margin' (modules) -> qrious 'padding' (pixels)
        // qrcode.js 'color.dark' -> qrious 'foreground'
        // qrcode.js 'color.light' -> qrious 'background'
        // qrcode.js 'errorCorrectionLevel' -> qrious 'level'
        const qrSize = opts.width || 260;
        const options = {
          element: canvas,
          value: link,
          size: qrSize,
          // Use a default pixel padding if margin isn't specified,
          // otherwise, guesstimate px from modules (e.g., 2 modules ~ 20px padding)
          padding: typeof opts.margin === 'number' ? (opts.margin * 10) : 20, 
          level: opts.errorCorrectionLevel || 'M',
          foreground: (opts.color && opts.color.dark) || '#5B21B6',
          background: (opts.color && opts.color.light) || '#FFFFFF'
        };
        
        // Ensure canvas dimensions match the QR size (Qrious may override, but we set them explicitly)
        if (canvas.width !== qrSize) canvas.width = qrSize;
        if (canvas.height !== qrSize) canvas.height = qrSize;
        
        // Just creating the instance renders it to the canvas
        new window.Qrious(options); 
        
      } catch (err) {
        console.error('QR generation exception (Qrious)', err);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fee';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#c33';
        ctx.textAlign = 'center';
        ctx.font = '12px sans-serif';
        ctx.fillText('QR Generation Failed', canvas.width/2, canvas.height/2);
      }
    }

    function downloadQr() {
      try {
        const canvas = document.getElementById('qrCanvas');
        if (!canvas) { console.warn('qrCanvas not found'); return; }
        const dataUrl = canvas.toDataURL('image/png');
        // small validation: if canvas is blank dataUrl will be a tiny header ‚Äî warn user
        if (!dataUrl || dataUrl.length < 200) {
          alert('QR image appears empty. Generate the QR code first and check the console for errors.');
          return;
        }
        const a = document.createElement('a');
        a.href = dataUrl;
        const safeRoom = (roomId || 'invite').replace(/[^a-z0-9-_]/gi, '');
        a.download = `chatroom-${safeRoom}-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        console.error('downloadQr failed', e);
        alert('Download failed: see console for details.');
      }
    }

    // Share modal UI
    const shareModalEl = document.getElementById('shareModal');
    const shareLinkEl = document.getElementById('shareLink');
    const copySuccessEl = document.getElementById('copySuccess');

    function showShareModal() {
      try {
        const link = window.location.origin + window.location.pathname + '?room=' + roomId;
        if (shareLinkEl) shareLinkEl.value = link;
        if (shareModalEl) shareModalEl.classList.remove('hidden');
        // Generate QR code immediately - async function handles its own errors
        requestAnimationFrame(() => {
          generateQrForLink(link).catch(err => console.error('QR generation error in showShareModal', err));
        });
      } catch (e) { 
        console.error('showShareModal error', e); 
        if (shareModalEl) shareModalEl.classList.remove('hidden'); 
      }
    }
    function hideShareModal() { if (shareModalEl) shareModalEl.classList.add('hidden'); if (copySuccessEl) copySuccessEl.classList.add('hidden'); }

    async function copyLinkToClipboard() {
      try {
        if (!shareLinkEl || !shareLinkEl.value) {
          console.warn('Share link element or value not found');
          return;
        }
        
        const textToCopy = shareLinkEl.value;
        const btn = document.getElementById('copyBtnModal');
        const copySuccessEl = document.getElementById('copySuccess');
        
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(textToCopy);
            if (btn) btn.classList.add('copy-animation');
            if (copySuccessEl) {
              copySuccessEl.classList.remove('hidden');
              copySuccessEl.textContent = '‚úì Link copied to clipboard!';
            }
            setTimeout(() => { 
              if (btn) btn.classList.remove('copy-animation'); 
            }, 500);
            setTimeout(() => { 
              if (copySuccessEl) copySuccessEl.classList.add('hidden'); 
            }, 3000);
            return;
          } catch (clipboardError) {
            console.warn('Clipboard API failed, trying fallback', clipboardError);
          }
        }
        
        // Fallback for older browsers
        shareLinkEl.select();
        shareLinkEl.setSelectionRange(0, 99999); // For mobile devices
        
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            if (btn) btn.classList.add('copy-animation');
            if (copySuccessEl) {
              copySuccessEl.classList.remove('hidden');
              copySuccessEl.textContent = '‚úì Link copied to clipboard!';
            }
            setTimeout(() => { 
              if (btn) btn.classList.remove('copy-animation'); 
            }, 500);
            setTimeout(() => { 
              if (copySuccessEl) copySuccessEl.classList.add('hidden'); 
            }, 3000);
          } else {
            throw new Error('execCommand copy failed');
          }
        } catch (execError) {
          // Last resort: show the text for manual copy
          if (copySuccessEl) {
            copySuccessEl.classList.remove('hidden');
            copySuccessEl.textContent = 'Please manually copy the link above';
            copySuccessEl.classList.remove('text-green-600');
            copySuccessEl.classList.add('text-yellow-600');
          }
          console.error('Copy failed with all methods', execError);
        }
      } catch (e) { 
        console.error('copy failed', e); 
        const copySuccessEl = document.getElementById('copySuccess');
        if (copySuccessEl) {
          copySuccessEl.classList.remove('hidden');
          copySuccessEl.textContent = 'Copy failed. Please select and copy manually.';
          copySuccessEl.classList.remove('text-green-600');
          copySuccessEl.classList.add('text-red-600');
        }
      }
    }

    // Graceful cleanup on close (best-effort)
    window.addEventListener('beforeunload', () => {
      if (!userId || !roomId) return;
      try { addDoc(messagesCollectionRef(), { type:'system', content: `${currentUser||'A user'} left the chat`, timestamp: serverTimestamp() }).catch(()=>{}); } catch(e){}
      try { deleteDoc(userDocRef()).catch(()=>{}); } catch(e){}
    });

    // attach event listeners for buttons (more reliable) - with null checks
    const shareBtn = document.getElementById('shareBtn');
    const closeShareBtn = document.getElementById('closeShare');
    const copyBtnModal = document.getElementById('copyBtnModal');
    const downloadQrBtn = document.getElementById('downloadQrBtn');
    const toggleUsersBtn = document.getElementById('toggleUsersBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const joinButton = document.getElementById('joinButton');
    const usernameInput = document.getElementById('usernameInput');
    const messageInput = document.getElementById('messageInput');
    
    if (shareBtn) {
      shareBtn.addEventListener('click', () => {
        try { showShareModal(); } catch (e) { console.error('shareBtn click handler error', e); showShareModal(); }
      });
    }
    
    if (closeShareBtn) {
      closeShareBtn.addEventListener('click', hideShareModal);
    }
    
    if (copyBtnModal) {
      copyBtnModal.addEventListener('click', copyLinkToClipboard);
    }
    
    if (downloadQrBtn) {
      downloadQrBtn.addEventListener('click', downloadQr);
    }
    
    if (toggleUsersBtn) {
      toggleUsersBtn.addEventListener('click', () => { 
        const usersSidebar = document.getElementById('usersSidebar');
        if (usersSidebar) usersSidebar.classList.toggle('hidden'); 
      });
    }
    
    if (leaveBtn) {
      leaveBtn.addEventListener('click', leaveChat);
    }
    
    if (joinButton) {
      joinButton.addEventListener('click', joinChat);
    }
    
    if (usernameInput) {
      usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') joinChat(); });
    }
    
    if (messageInput) {
      messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    }

    // ensure shareLink regenerates on focus - optimized for speed
    if (shareLinkEl) {
      shareLinkEl.addEventListener('focus', () => {
        const link = window.location.origin + window.location.pathname + '?room=' + roomId;
        requestAnimationFrame(() => {
          generateQrForLink(link).catch(err => console.error('QR generation error on focus', err));
        });
      });
    }

    // populate shareLink early on load and ensure QR library is ready
    window.addEventListener('load', () => {
      if (!roomId) getRoomId();
      if (shareLinkEl) {
        const link = window.location.origin + window.location.pathname + '?room=' + roomId;
        shareLinkEl.value = link;
      }
      
      // Wait a bit for Qrious library to load, then generate QR if modal is visible
      setTimeout(() => {
        if (shareModalEl && !shareModalEl.classList.contains('hidden')) {
          const link = window.location.origin + window.location.pathname + '?room=' + roomId;
          generateQrForLink(link).catch(err => console.error('QR generation error on load', err));
        }
      }, 500);
    });
    
    // Also try to generate QR when modal becomes visible - optimized for speed
    if (shareModalEl) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (!shareModalEl.classList.contains('hidden')) {
              const link = window.location.origin + window.location.pathname + '?room=' + roomId;
              // Use requestAnimationFrame for immediate rendering
              requestAnimationFrame(() => {
                generateQrForLink(link).catch(err => console.error('QR generation error in observer', err));
              });
            }
          }
        });
      });
      observer.observe(shareModalEl, { attributes: true });
    }

  </script>
</body>
</html>